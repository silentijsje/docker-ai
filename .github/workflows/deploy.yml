---
name: Deploy Ansible

on:
  push:
    branches:
      - main
    paths:
      - 'ai-ansible/**'
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Servers
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4

      - name: Set up credentials
        run: |
          cd ai-ansible
          echo "${{ secrets.VAULT_PASSWORD }}" > .vault_pass
          chmod 600 .vault_pass
          # Copy runner SSH key to workspace
          cp ~/.ssh/github_runner_ed25519 ./.ssh_key
          chmod 600 ./.ssh_key

      - name: Run Ansible playbook
        run: |
          cd ai-ansible
          ansible-playbook site.yml \
            --vault-password-file=.vault_pass \
            --private-key=./.ssh_key

      - name: Cleanup
        if: always()
        run: |
          cd ai-ansible
          rm -f .vault_pass .ssh_key
