---
# Main entry point for containers role
# Deploys enabled containers from the enabled_containers variable

# Remove stale crowdsec dir left from previous deployments (no traefik on these hosts)
- name: Remove stale crowdsec directory
  ansible.builtin.file:
    path: "{{ container_data_root }}/crowdsec"
    state: absent

# Ensure Docker network exists (MUST BE FIRST)
- name: Ensure Docker network exists
  community.docker.docker_network:
    name: "{{ container_network }}"
    state: present

# =============================================================================
# PHASE 1: Infrastructure Services (Deploy in Order)
# =============================================================================
# Traefik MUST be first - all other services depend on it

- name: Deploy Portainer
  ansible.builtin.include_tasks: portainer.yml
  when: enabled_containers.portainer | default(false)
  tags:
    - infrastructure
    - portainer

- name: Deploy Watchtower
  ansible.builtin.include_tasks: watchtower.yml
  when: enabled_containers.watchtower | default(false)
  tags:
    - infrastructure
    - watchtower

- name: Deploy Homepage
  ansible.builtin.include_tasks: homepage.yml
  when: enabled_containers.homepage | default(false)
  tags:
    - infrastructure
    - homepage

# =============================================================================
# PHASE 2+: Application Services
# =============================================================================

- name: Deploy Radarr
  ansible.builtin.include_tasks: radarr.yml
  when: enabled_containers.radarr | default(false)
  tags:
    - media_management
    - radarr

- name: Deploy Sonarr
  ansible.builtin.include_tasks: sonarr.yml
  when: enabled_containers.sonarr | default(false)
  tags:
    - media_management
    - sonarr

- name: Deploy SABnzbd
  ansible.builtin.include_tasks: sabnzbd.yml
  when: enabled_containers.sabnzbd | default(false)
  tags:
    - download_clients
    - sabnzbd

- name: Deploy qBittorrent
  ansible.builtin.include_tasks: qbittorrent.yml
  when: enabled_containers.qbittorrent | default(false)
  tags:
    - download_clients
    - qbittorrent

- name: Deploy Booklore
  ansible.builtin.include_tasks: booklore.yml
  when: enabled_containers.booklore | default(false)
  tags:
    - content
    - booklore
