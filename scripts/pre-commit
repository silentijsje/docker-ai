#!/bin/bash
#
# Pre-commit hook to prevent committing unencrypted Ansible vault files
#
# Install: cp scripts/pre-commit .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit
#

# Find all vault files being committed
VAULT_FILES=$(git diff --cached --name-only | grep -E "vault.*\.yml$|.*vault\.yml$")

if [ -z "$VAULT_FILES" ]; then
    exit 0
fi

# Check each vault file
UNENCRYPTED=""
for file in $VAULT_FILES; do
    if [ -f "$file" ]; then
        # Check if file starts with $ANSIBLE_VAULT
        if ! head -1 "$file" | grep -q '^\$ANSIBLE_VAULT'; then
            UNENCRYPTED="$UNENCRYPTED\n  - $file"
        fi
    fi
done

if [ -n "$UNENCRYPTED" ]; then
    echo "============================================================"
    echo "ERROR: Unencrypted vault file(s) detected!"
    echo "============================================================"
    echo -e "The following vault files are NOT encrypted:$UNENCRYPTED"
    echo ""
    echo "Please encrypt before committing:"
    echo "  ansible-vault encrypt <file> --vault-password-file=.vault_pass"
    echo ""
    echo "To bypass this check (NOT recommended):"
    echo "  git commit --no-verify"
    echo "============================================================"
    exit 1
fi

exit 0
